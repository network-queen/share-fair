---
# Nginx reverse proxy configuration (K8s-adapted â€” HTTP only, TLS at Ingress)
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: share-fair
  labels:
    app: nginx
    app.kubernetes.io/part-of: share-fair
data:
  nginx.conf: |
    worker_processes auto;

    events {
        worker_connections 1024;
    }

    http {
        include       /etc/nginx/mime.types;
        default_type  application/octet-stream;

        log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent"';
        access_log /var/log/nginx/access.log main;
        error_log  /var/log/nginx/error.log warn;

        sendfile        on;
        tcp_nopush      on;
        keepalive_timeout 65;
        client_max_body_size 50m;

        gzip on;
        gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

        server {
            listen 80;
            server_name _;

            # Spring Boot REST API
            location /api/ {
                proxy_pass         http://api:8080;
                proxy_set_header   Host              $host;
                proxy_set_header   X-Real-IP         $remote_addr;
                proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
                proxy_set_header   X-Forwarded-Proto $http_x_forwarded_proto;
                proxy_set_header   X-Forwarded-Host  $host;
                proxy_set_header   X-Forwarded-Port  $server_port;
                proxy_read_timeout 60s;
            }

            # Spring Boot Actuator (metrics, health)
            location /actuator/ {
                proxy_pass         http://api:8080;
                proxy_set_header   Host              $host;
                proxy_set_header   X-Real-IP         $remote_addr;
                proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
                proxy_set_header   X-Forwarded-Proto $http_x_forwarded_proto;
            }

            # WebSocket endpoint (STOMP for real-time chat + notifications)
            location /ws {
                proxy_pass         http://api:8080;
                proxy_http_version 1.1;
                proxy_set_header   Upgrade    $http_upgrade;
                proxy_set_header   Connection "upgrade";
                proxy_set_header   Host       $host;
                proxy_read_timeout 3600s;
            }

            # React SPA (everything else)
            location / {
                proxy_pass         http://frontend:80;
                proxy_set_header   Host              $host;
                proxy_set_header   X-Real-IP         $remote_addr;
                proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
                proxy_set_header   X-Forwarded-Proto $http_x_forwarded_proto;
            }
        }
    }

---
# Prometheus scrape configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: share-fair
  labels:
    app: prometheus
    app.kubernetes.io/part-of: share-fair
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    scrape_configs:
      - job_name: 'sharefair-api'
        metrics_path: '/actuator/prometheus'
        static_configs:
          - targets: ['api:8080']
            labels:
              application: 'sharefair-api'
              namespace: 'share-fair'

      - job_name: 'kubernetes-pods'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names: [share-fair]
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: "true"
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
          - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
            action: replace
            regex: ([^:]+)(?::\d+)?;(\d+)
            replacement: $1:$2
            target_label: __address__

---
# Loki log aggregation configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: loki-config
  namespace: share-fair
  labels:
    app: loki
    app.kubernetes.io/part-of: share-fair
data:
  loki-config.yml: |
    auth_enabled: false

    server:
      http_listen_port: 3100
      grpc_listen_port: 9096

    common:
      instance_addr: 127.0.0.1
      path_prefix: /loki
      storage:
        filesystem:
          chunks_directory: /loki/chunks
          rules_directory: /loki/rules
      replication_factor: 1
      ring:
        kvstore:
          store: inmemory

    schema_config:
      configs:
        - from: 2020-10-24
          store: tsdb
          object_store: filesystem
          schema: v13
          index:
            prefix: index_
            period: 24h

    limits_config:
      reject_old_samples: true
      reject_old_samples_max_age: 168h
      allow_structured_metadata: false

    compactor:
      working_directory: /loki/compactor

---
# Promtail log shipper configuration (K8s pod log discovery)
apiVersion: v1
kind: ConfigMap
metadata:
  name: promtail-config
  namespace: share-fair
  labels:
    app: promtail
    app.kubernetes.io/part-of: share-fair
data:
  promtail-config.yml: |
    server:
      http_listen_port: 9080
      grpc_listen_port: 0

    positions:
      filename: /tmp/positions.yaml

    clients:
      - url: http://loki:3100/loki/api/v1/push

    scrape_configs:
      - job_name: kubernetes-pods
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names: [share-fair]
        pipeline_stages:
          - cri: {}
          - json:
              expressions:
                log_level: level
                log_message: message
                logger: logger_name
          - labels:
              log_level:
              logger:
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_node_name]
            target_label: __host__
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
          - source_labels: [__meta_kubernetes_pod_container_name]
            target_label: container
          - source_labels: [__meta_kubernetes_pod_label_app]
            target_label: app
          - replacement: /var/log/pods/*$1/*.log
            separator: /
            source_labels:
              - __meta_kubernetes_pod_uid
              - __meta_kubernetes_pod_container_name
            target_label: __path__

---
# Grafana datasource auto-provisioning
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: share-fair
  labels:
    app: grafana
    app.kubernetes.io/part-of: share-fair
data:
  datasources.yml: |
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus:9090
        isDefault: true
        editable: true

      - name: Loki
        type: loki
        access: proxy
        url: http://loki:3100
        editable: true
